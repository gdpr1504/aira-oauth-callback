<!DOCTYPE html>
<html>
  <head>
    <title>OAuth Callback</title>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
    <p>Signing in...</p>
    <script>
      // Function to exchange authorization code for user data
      async function exchangeCodeForUserData(code) {
        try {
          console.log("Exchanging code for user data...");

          // Store the code in localStorage and let the extension handle the backend request
          localStorage.setItem("aira_oauth_code", code);
          localStorage.setItem("aira_oauth_state", "aira-oauth-extension");
          localStorage.setItem("aira_oauth_timestamp", Date.now().toString());

          console.log(
            "OAuth code stored in localStorage, extension will handle backend request"
          );

          // Send code to extension for backend processing
          window.postMessage(
            {
              type: "OAUTH_CODE",
              code: code,
              state: "aira-oauth-extension",
            },
            "*"
          );

          // Show processing message
          document.body.innerHTML = "<p>Processing authentication...</p>";
        } catch (error) {
          console.error("Error processing OAuth code:", error);

          // Store error in localStorage
          localStorage.setItem("aira_oauth_error", error.message);
          localStorage.setItem(
            "aira_oauth_error_timestamp",
            Date.now().toString()
          );

          // Send error message to extension
          window.postMessage(
            {
              type: "OAUTH_ERROR",
              error: error.message,
            },
            "*"
          );

          document.body.innerHTML = `<p>Error: ${error.message}</p>`;
        }
      }

      (function () {
        console.log("Callback page loaded");
        console.log("Current URL:", window.location.href);
        console.log("Hash:", window.location.hash);

        // Extract access token from URL hash (implicit grant flow)
        const hash = window.location.hash.substring(1); // Remove # from hash
        const hashParams = new URLSearchParams(hash);
        const accessToken = hashParams.get("access_token");
        const state = hashParams.get("state");
        const error = hashParams.get("error");
        const tokenType = hashParams.get("token_type");
        const expiresIn = hashParams.get("expires_in");

        console.log("Access Token:", accessToken ? "present" : "missing");
        console.log("State:", state);
        console.log("Error:", error);
        console.log("Token Type:", tokenType);
        console.log("Expires In:", expiresIn);

        if (error) {
          console.log("OAuth error:", error);
          document.body.innerHTML = `<p>Error: ${error}</p>`;
          return;
        }

        if (accessToken && state && state.startsWith("aira-oauth-")) {
          console.log(
            "Processing OAuth token:",
            accessToken.substring(0, 20) + "..."
          );

          // Store access token in localStorage
          localStorage.setItem("aira_oauth_token", accessToken);
          localStorage.setItem("aira_oauth_state", state);
          localStorage.setItem("aira_oauth_token_type", tokenType || "Bearer");
          localStorage.setItem("aira_oauth_expires_in", expiresIn || "3600");
          localStorage.setItem("aira_oauth_timestamp", Date.now().toString());

          console.log("OAuth token stored in localStorage");

          // Send access token to extension via postMessage
          window.postMessage(
            {
              type: "OAUTH_TOKEN",
              token: accessToken,
              state: state,
              tokenType: tokenType,
              expiresIn: expiresIn,
            },
            "*"
          );

          // Show success message with token for easy copying
          document.body.innerHTML = `
            <div style="padding: 20px; font-family: Arial, sans-serif;">
              <h2 style="color: #4CAF50;">âœ… Authentication Successful!</h2>
              <p><strong>Your access token:</strong></p>
              <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; word-break: break-all; font-family: monospace; font-size: 12px; margin: 10px 0; position: relative;">
                <span id="tokenText">${accessToken}</span>
                <button id="copyBtn" style="position: absolute; top: 5px; right: 5px; background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 11px;">Copy</button>
              </div>
              <p><strong>Instructions:</strong></p>
              <ol>
                <li>Click the "Copy" button above to copy the token</li>
                <li>Go back to the extension popup</li>
                <li>Click the purple "Manual Token" button</li>
                <li>Paste the token when prompted</li>
              </ol>
              <p style="color: #666; font-size: 14px;">You can close this window when done.</p>
            </div>
          `;
          
          // Add copy functionality
          document.getElementById('copyBtn').addEventListener('click', function() {
            const tokenText = document.getElementById('tokenText').textContent;
            navigator.clipboard.writeText(tokenText).then(function() {
              const btn = document.getElementById('copyBtn');
              const originalText = btn.textContent;
              btn.textContent = 'Copied!';
              btn.style.background = '#45a049';
              setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#4CAF50';
              }, 2000);
            }).catch(function(err) {
              console.error('Failed to copy token: ', err);
              alert('Failed to copy token. Please copy it manually.');
            });
          });
        } else {
          console.log("No valid token or state found");
          document.body.innerHTML = "<p>Error: No access token found.</p>";
        }
      })();
    </script>
  </body>
</html>
