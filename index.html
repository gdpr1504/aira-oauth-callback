<!DOCTYPE html>
<html>
  <head>
    <title>OAuth Callback</title>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
    <p>Signing in...</p>
    <script>
      (function () {
        console.log("Callback page loaded");
        console.log("Current URL:", window.location.href);
        console.log("Search params:", window.location.search);

        // Extract authorization code from URL query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");
        const error = urlParams.get("error");

        console.log("Code:", code);
        console.log("State:", state);
        console.log("Error:", error);

        if (error) {
          console.log("OAuth error:", error);
          document.body.innerHTML = `<p>Error: ${error}</p>`;
          return;
        }

        if (code && state === "aira-oauth-extension") {
          console.log("Sending OAUTH_CODE message");
          // Send authorization code to extension via postMessage
          window.postMessage(
            {
              type: "OAUTH_CODE",
              code: code,
              state: state,
            },
            "*"
          );

          // Show success message
          document.body.innerHTML =
            "<p>Authentication successful! You can close this window.</p>";

          // Close tab automatically after a delay
          setTimeout(() => window.close(), 2000);
        } else {
          console.log("No valid code or state found");
          document.body.innerHTML =
            "<p>Error: No authorization code found.</p>";
        }
      })();
    </script>
  </body>
</html>
