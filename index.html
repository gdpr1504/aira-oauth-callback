<!DOCTYPE html>
<html>
  <head>
    <title>OAuth Callback</title>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: #f5f5f5;
      }
      .status-container {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .success {
        color: #4caf50;
      }
      .error {
        color: #f44336;
      }
      .loading {
        color: #2196f3;
      }
    </style>
  </head>
  <body>
    <div class="status-container">
      <h2 id="status">Processing authentication...</h2>
    </div>
    <script>
      // Encryption utilities (same as extension)
      const ENCRYPTION_KEY = "aira-oauth-extension-key-2025";

      async function encryptToken(token) {
        try {
          console.log("Starting encryption process in callback...");
          const encoder = new TextEncoder();
          const data = encoder.encode(token);
          console.log("Data encoded, length:", data.length);

          const key = await crypto.subtle.importKey(
            "raw",
            encoder.encode(ENCRYPTION_KEY),
            { name: "AES-GCM" },
            false,
            ["encrypt"]
          );
          console.log("Key imported successfully in callback");

          const iv = crypto.getRandomValues(new Uint8Array(12));
          console.log("IV generated:", iv.length, "bytes");

          const encrypted = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            key,
            data
          );
          console.log(
            "Encryption completed, encrypted length:",
            encrypted.byteLength
          );

          const encryptedArray = new Uint8Array(encrypted);
          const combined = new Uint8Array(iv.length + encryptedArray.length);
          combined.set(iv);
          combined.set(encryptedArray, iv.length);

          const result = btoa(String.fromCharCode(...combined));
          console.log("Final encrypted result length:", result.length);
          console.log("Encryption successful in callback!");
          return result;
        } catch (error) {
          console.error("Encryption failed in callback:", error);
          console.log("Falling back to unencrypted token in callback");
          return token; // Fallback to unencrypted
        }
      }

      (async function () {
        console.log("Callback page loaded");

        // Extract access token from URL hash (implicit grant flow)
        const hash = window.location.hash.substring(1);
        const hashParams = new URLSearchParams(hash);
        const accessToken = hashParams.get("access_token");
        const state = hashParams.get("state");
        const error = hashParams.get("error");

        if (error) {
          console.log("OAuth error:", error);
          document.getElementById(
            "status"
          ).textContent = `Authentication failed: ${error}`;
          document.getElementById("status").className = "error";
          return;
        }

        if (accessToken && state && state.startsWith("aira-oauth-")) {
          console.log("Processing OAuth token...");

          // Encrypt the access token before storing
          console.log(
            "Original token (first 20 chars):",
            accessToken.substring(0, 20) + "..."
          );
          const encryptedToken = await encryptToken(accessToken);
          console.log(
            "Encrypted token (first 20 chars):",
            encryptedToken.substring(0, 20) + "..."
          );
          console.log("Token encrypted for storage");

          // Store encrypted access token in localStorage
          localStorage.setItem("aira_oauth_token", encryptedToken);
          localStorage.setItem("aira_oauth_state", state);
          localStorage.setItem("aira_oauth_token_encrypted", "true");
          localStorage.setItem(
            "aira_oauth_token_type",
            hashParams.get("token_type") || "Bearer"
          );
          localStorage.setItem(
            "aira_oauth_expires_in",
            hashParams.get("expires_in") || "3600"
          );
          localStorage.setItem("aira_oauth_timestamp", Date.now().toString());

          console.log("Encrypted OAuth token stored in localStorage");

          // Send access token to extension via postMessage (still send original for processing)
          window.postMessage(
            {
              type: "OAUTH_TOKEN",
              token: accessToken,
              state: state,
              tokenType: hashParams.get("token_type"),
              expiresIn: hashParams.get("expires_in"),
            },
            "*"
          );

          // Show success status
          document.getElementById("status").textContent =
            "Authentication successful!";
          document.getElementById("status").className = "success";
        } else {
          console.log("No valid token or state found");
          document.getElementById("status").textContent =
            "No access token found.";
          document.getElementById("status").className = "error";
        }
      })();
    </script>
  </body>
</html>
