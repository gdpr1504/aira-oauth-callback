<!DOCTYPE html>
<html>
  <head>
    <title>OAuth Callback</title>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
    <p>Signing in...</p>
    <script>
      // Function to exchange authorization code for user data
      async function exchangeCodeForUserData(code) {
        try {
          console.log("Exchanging code for user data...");

          // Store the code in localStorage and let the extension handle the backend request
          localStorage.setItem("aira_oauth_code", code);
          localStorage.setItem("aira_oauth_state", "aira-oauth-extension");
          localStorage.setItem("aira_oauth_timestamp", Date.now().toString());

          console.log(
            "OAuth code stored in localStorage, extension will handle backend request"
          );

          // Send code to extension for backend processing
          window.postMessage(
            {
              type: "OAUTH_CODE",
              code: code,
              state: "aira-oauth-extension",
            },
            "*"
          );

          // Show processing message
          document.body.innerHTML = "<p>Processing authentication...</p>";
        } catch (error) {
          console.error("Error processing OAuth code:", error);

          // Store error in localStorage
          localStorage.setItem("aira_oauth_error", error.message);
          localStorage.setItem(
            "aira_oauth_error_timestamp",
            Date.now().toString()
          );

          // Send error message to extension
          window.postMessage(
            {
              type: "OAUTH_ERROR",
              error: error.message,
            },
            "*"
          );

          document.body.innerHTML = `<p>Error: ${error.message}</p>`;
        }
      }

      (function () {
        console.log("Callback page loaded");
        console.log("Current URL:", window.location.href);
        console.log("Hash:", window.location.hash);

        // Extract access token from URL hash (implicit grant flow)
        const hash = window.location.hash.substring(1); // Remove # from hash
        const hashParams = new URLSearchParams(hash);
        const accessToken = hashParams.get("access_token");
        const state = hashParams.get("state");
        const error = hashParams.get("error");
        const tokenType = hashParams.get("token_type");
        const expiresIn = hashParams.get("expires_in");

        console.log("Access Token:", accessToken ? "present" : "missing");
        console.log("State:", state);
        console.log("Error:", error);
        console.log("Token Type:", tokenType);
        console.log("Expires In:", expiresIn);

        if (error) {
          console.log("OAuth error:", error);
          document.body.innerHTML = `<p>Error: ${error}</p>`;
          return;
        }

        if (accessToken && state && state.startsWith("aira-oauth-")) {
          console.log(
            "Processing OAuth token:",
            accessToken.substring(0, 20) + "..."
          );

          // Store access token in localStorage
          localStorage.setItem("aira_oauth_token", accessToken);
          localStorage.setItem("aira_oauth_state", state);
          localStorage.setItem("aira_oauth_token_type", tokenType || "Bearer");
          localStorage.setItem("aira_oauth_expires_in", expiresIn || "3600");
          localStorage.setItem("aira_oauth_timestamp", Date.now().toString());

          console.log("OAuth token stored in localStorage");

          // Send access token to extension via postMessage
          window.postMessage(
            {
              type: "OAUTH_TOKEN",
              token: accessToken,
              state: state,
              tokenType: tokenType,
              expiresIn: expiresIn,
            },
            "*"
          );

          // Show success message
          document.body.innerHTML =
            "<p>Authentication successful! You can close this window.</p>";

          // Close tab automatically after a delay
          setTimeout(() => window.close(), 3000);
        } else {
          console.log("No valid token or state found");
          document.body.innerHTML = "<p>Error: No access token found.</p>";
        }
      })();
    </script>
  </body>
</html>
