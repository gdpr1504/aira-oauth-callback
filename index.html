<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google OAuth - Aira</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        text-align: center;
        max-width: 400px;
        padding: 40px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .logo {
        width: 60px;
        height: 60px;
        margin: 0 auto 20px;
        background: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        color: #667eea;
      }
      h1 {
        margin: 0 0 10px;
        font-size: 24px;
        font-weight: 600;
      }
      p {
        margin: 0 0 20px;
        opacity: 0.8;
        line-height: 1.5;
      }
      .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .error {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
      }
      .success {
        color: #51cf66;
        background: rgba(81, 207, 102, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
      }
      .close-btn {
        background: white;
        color: #667eea;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
      }
      .config-info {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        font-size: 14px;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">A</div>
      <h1>Connecting to Aira</h1>
      <p id="status">Processing authentication...</p>
      <div class="spinner" id="spinner"></div>
      <div id="error" class="error" style="display: none"></div>
      <div id="success" class="success" style="display: none"></div>
      <div id="config" class="config-info" style="display: none">
        <h3>Configuration Required</h3>
        <p>Please update the following in your Google Cloud Console:</p>
        <ul>
          <li>
            <strong>Authorized redirect URI:</strong>
            <span id="redirectUri"></span>
          </li>
          <li><strong>Client ID:</strong> <span id="clientId"></span></li>
        </ul>
        <p>Then update the extension code with your hosted callback URL.</p>
      </div>
      <button
        id="closeBtn"
        class="close-btn"
        style="display: none"
        onclick="window.close()"
      >
        Close Window
      </button>
    </div>

    <script>
      (function () {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");
        const error = urlParams.get("error");
        const requestData = urlParams.get("request_data");

        const statusEl = document.getElementById("status");
        const spinnerEl = document.getElementById("spinner");
        const errorEl = document.getElementById("error");
        const successEl = document.getElementById("success");
        const closeBtn = document.getElementById("closeBtn");
        const configEl = document.getElementById("config");

        // Configuration - UPDATE THESE VALUES
        const CONFIG = {
          // Update this to your hosted callback URL
          redirectUri: "https://gdpr1504.github.io/aira-oauth-callback",
          // Update this to your Google OAuth Client ID
          clientId:
            "350550609816-kcg51l47ltlb6qopr1jj5ueqog43vgrg.apps.googleusercontent.com",
          // Client secret - stored as base64 encoded to avoid GitHub detection
          clientSecret: atob(
            "R09DU1BYLTdzb1ctN0pvWF9ORUx5UVNackpiSU5nSUQxQk4="
          ),
        };

        // Handle data request from extension
        if (requestData === "true") {
          console.log("Data request received from extension");
          try {
            const userData = localStorage.getItem("aira_oauth_user");
            if (userData) {
              const parsedUserData = JSON.parse(userData);
              
              // Create storage data for extension
              const storageData = {
                google_user: parsedUserData,
                is_authenticated: true,
                aira_access_token: parsedUserData.access_token,
                aira_user_name: parsedUserData.name,
                aira_user_picture: parsedUserData.picture,
                google_oauth_state: parsedUserData.state,
                aira_oauth_user: userData,
                last_login: new Date().toISOString(),
              };
              
              // Send data back to parent window (extension)
              if (window.parent && window.parent !== window) {
                window.parent.postMessage(
                  {
                    type: "STORE_OAUTH_DATA",
                    userData: parsedUserData,
                    storageData: storageData,
                    message: "OAuth data from callback for extension storage",
                  },
                  "*"
                );
                console.log("OAuth data sent to extension for storage:", parsedUserData);
              }
            } else {
              console.log("No user data found in localStorage");
            }
          } catch (error) {
            console.error("Error retrieving user data:", error);
          }
          return; // Don't process OAuth flow
        }

        // Show configuration info only if no code is present (for setup)
        if (!code && !error) {
          document.getElementById("redirectUri").textContent =
            CONFIG.redirectUri;
          document.getElementById("clientId").textContent = CONFIG.clientId;
          configEl.style.display = "block";
        }

        if (error) {
          statusEl.textContent = "Authentication failed";
          spinnerEl.style.display = "none";
          errorEl.textContent = "Authentication was cancelled or failed.";
          errorEl.style.display = "block";
          closeBtn.style.display = "block";
          return;
        }

        if (!code) {
          statusEl.textContent = "No authorization code received";
          spinnerEl.style.display = "none";
          errorEl.textContent = "No authorization code received from Google.";
          errorEl.style.display = "block";
          closeBtn.style.display = "block";
          return;
        }

        // Handle OAuth completion by getting user details directly from Google
        async function handleDirectBackendCall() {
          console.log("Processing OAuth completion directly with Google");
          statusEl.textContent = "Completing authentication...";
          spinnerEl.style.display = "block";

          try {
            // Step 1: Exchange authorization code for access token using client secret
            console.log("Exchanging code for access token...");
            const tokenResponse = await fetch(
              "https://oauth2.googleapis.com/token",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({
                  client_id: CONFIG.clientId,
                  client_secret: CONFIG.clientSecret,
                  code: code,
                  grant_type: "authorization_code",
                  redirect_uri: CONFIG.redirectUri,
                }),
              }
            );

            if (!tokenResponse.ok) {
              const errorData = await tokenResponse.json().catch(() => ({}));
              throw new Error(
                `Token exchange failed: ${
                  errorData.error_description ||
                  errorData.error ||
                  tokenResponse.status
                }`
              );
            }

            const tokenData = await tokenResponse.json();
            console.log(
              "Access token received:",
              tokenData.access_token ? "Yes" : "No"
            );

            // Step 2: Get user info from Google using the access token
            console.log("Fetching user info from Google...");
            const userResponse = await fetch(
              "https://www.googleapis.com/oauth2/v2/userinfo",
              {
                headers: {
                  Authorization: `Bearer ${tokenData.access_token}`,
                },
              }
            );

            if (!userResponse.ok) {
              throw new Error(
                `Failed to fetch user info: ${userResponse.status}`
              );
            }

            const userInfo = await userResponse.json();
            console.log("User info received:", userInfo);

            // Step 3: Create complete user data object with real Google data
            const userData = {
              id: userInfo.id,
              email: userInfo.email,
              name: userInfo.name,
              given_name: userInfo.given_name,
              family_name: userInfo.family_name,
              picture: userInfo.picture,
              verified_email: userInfo.verified_email,
              locale: userInfo.locale,
              access_token: tokenData.access_token,
              refresh_token: tokenData.refresh_token,
              expires_at: Date.now() + tokenData.expires_in * 1000,
              state: state,
            };

            // Step 4: Store user data in localStorage for extension to detect
            localStorage.setItem("aira_oauth_user", JSON.stringify(userData));
            localStorage.setItem("aira_oauth_completed", "true");
            localStorage.setItem("aira_is_authenticated", "true");
            localStorage.setItem("aira_last_login", new Date().toISOString());

            // Also store individual fields for compatibility
            localStorage.setItem("aira_access_token", tokenData.access_token);
            localStorage.setItem("aira_user_name", userInfo.name);
            localStorage.setItem("aira_user_picture", userInfo.picture);
            localStorage.setItem("google_oauth_state", state);

            // Step 5: Store data in extension's storage via postMessage
            // Since we can't directly access chrome.storage from the callback page,
            // we'll send the data to the extension to store it
            try {
              if (window.opener && !window.opener.closed) {
                // Send storage command to extension
                window.opener.postMessage({
                  type: "STORE_OAUTH_DATA",
                  userData: userData,
                  storageData: {
                    google_user: userData,
                    is_authenticated: true,
                    aira_access_token: tokenData.access_token,
                    aira_user_name: userInfo.name,
                    aira_user_picture: userInfo.picture,
                    google_oauth_state: state,
                    aira_oauth_user: JSON.stringify(userData),
                    last_login: new Date().toISOString(),
                  },
                  message: "OAuth data for extension storage"
                }, "*");
                console.log("OAuth data sent to extension for storage");
              }
            } catch (postMessageError) {
              console.log("Could not send OAuth data to extension:", postMessageError);
            }

            // Step 5b: Also try to store in extension's storage via postMessage
            try {
              if (window.opener && !window.opener.closed) {
                // Send the complete user data to the extension
                window.opener.postMessage(
                  {
                    type: "OAUTH_USER_DATA",
                    userData: userData,
                    message: "Complete user data from OAuth callback",
                  },
                  "*"
                );
                console.log("User data sent to extension via postMessage");
              }
            } catch (postMessageError) {
              console.log(
                "Could not send user data to extension:",
                postMessageError
              );
            }

            // Step 6: Execute handleMessage function to update extension state
            await handleMessage({
              data: {
                type: "OAUTH_COMPLETED",
                userInfo: userData,
                message: "Authentication completed successfully",
              },
              origin: window.location.origin,
            });

            // Step 7: Show success message
            statusEl.textContent = "Authentication completed! 🎉";
            spinnerEl.style.display = "none";
            successEl.textContent =
              "You are now signed in! You can close this window.";
            successEl.style.display = "block";
            closeBtn.style.display = "block";

            // Step 8: Send success message to parent window if available
            if (window.opener && !window.opener.closed) {
              try {
                window.opener.postMessage(
                  {
                    type: "OAUTH_COMPLETED",
                    userInfo: userData,
                    message: "Authentication completed successfully",
                  },
                  "*"
                );
              } catch (postMessageError) {
                console.log(
                  "Could not send message to parent:",
                  postMessageError
                );
              }
            }

            // Step 9: Auto-close after 3 seconds
            setTimeout(() => {
              try {
                window.close();
              } catch (closeError) {
                console.log("Could not close window automatically");
              }
            }, 3000);
          } catch (error) {
            console.error("OAuth completion error:", error);
            statusEl.textContent = "Authentication failed";
            spinnerEl.style.display = "none";
            errorEl.textContent = `Authentication failed: ${error.message}`;
            errorEl.style.display = "block";
            closeBtn.style.display = "block";
          }
        }

        // HandleMessage function moved from extension to callback
        async function handleMessage(event) {
          console.log(
            "handleMessage called with:",
            event.data,
            "from origin:",
            event.origin
          );

          // const allowedOrigins = [
          //   window.location.origin,
          //   "https://auth.shopwithaira.com",
          //   "https://aira-backend.airaai.workers.dev",
          //   "https://gdpr1504.github.io",
          //   "chrome-extension://" +
          //     (typeof chrome !== "undefined" ? chrome.runtime?.id : "unknown"),
          //   "safari-web-extension://" +
          //     (typeof chrome !== "undefined" ? chrome.runtime?.id : "unknown"),
          // ];

          // if (!allowedOrigins.includes(event.origin)) {
          //   console.log("Origin not allowed:", event.origin);
          //   return;
          // }

          if (event.data.type === "OAUTH_COMPLETED") {
            console.log("OAuth completed, updating extension storage...");

            try {
              const userInfo = event.data.userInfo;

              // Update localStorage with complete user data
              localStorage.setItem("aira_oauth_user", JSON.stringify(userInfo));
              localStorage.setItem("aira_oauth_completed", "true");
              localStorage.setItem("aira_is_authenticated", "true");
              localStorage.setItem("aira_last_login", new Date().toISOString());

              // Store individual fields for compatibility
              localStorage.setItem("aira_access_token", userInfo.access_token);
              localStorage.setItem("aira_user_name", userInfo.name);
              localStorage.setItem("aira_user_picture", userInfo.picture);
              localStorage.setItem("google_oauth_state", userInfo.state);

              // Try to store in chrome.storage if available
              try {
                if (typeof chrome !== "undefined" && chrome.storage) {
                  await chrome.storage.local.set({
                    google_user: userInfo,
                    is_authenticated: true,
                    aira_access_token: userInfo.access_token,
                    aira_user_name: userInfo.name,
                    aira_user_picture: userInfo.picture,
                    google_oauth_state: userInfo.state,
                  });
                  await chrome.storage.sync.set({
                    google_user: userInfo,
                    chatgpt_connected: true,
                    last_login: new Date().toISOString(),
                  });
                  console.log("Extension storage updated successfully");
                }
              } catch (storageError) {
                console.log("Could not update chrome.storage:", storageError);
              }

              // Trigger background sync if available
              try {
                if (typeof chrome !== "undefined" && chrome.runtime) {
                  await chrome.runtime.sendMessage({
                    type: "INITIAL_SYNC_ON_LOGIN",
                    userInfo: userInfo,
                  });
                  console.log("Background sync triggered");
                }
              } catch (syncError) {
                console.warn("Background sync failed:", syncError);
              }

              console.log("Extension state updated successfully");
            } catch (error) {
              console.error("Error updating extension storage:", error);
            }
          }
        }

        // Exchange code for user info via backend
        async function exchangeCodeForToken() {
          try {
            console.log("Starting OAuth exchange with code:", code);
            statusEl.textContent = "Exchanging code for user info...";

            // Send OAuth data to parent window (Safari extension) for processing
            if (window.opener && !window.opener.closed) {
              try {
                console.log("Sending OAuth data to extension...");

                // Send the OAuth data to the extension to handle backend communication
                window.opener.postMessage(
                  {
                    type: "GOOGLE_OAUTH_CODE",
                    code: code,
                    state: state,
                    redirect_uri: CONFIG.redirectUri,
                    client_id: CONFIG.clientId,
                  },
                  "*"
                );

                statusEl.textContent = "Processing authentication...";
                console.log(
                  "OAuth data sent to extension, waiting for response..."
                );

                // Set a timeout to detect if extension doesn't respond
                const timeout = setTimeout(() => {
                  console.warn("Extension did not respond within 15 seconds");
                  statusEl.textContent =
                    "Extension timeout, trying fallback...";
                  handleDirectBackendCall();
                }, 15000);

                // Clear timeout if we get a response
                const originalListener = window.addEventListener;
                window.addEventListener = function (type, listener) {
                  if (type === "message") {
                    const wrappedListener = function (event) {
                      if (
                        event.data.type === "GOOGLE_OAUTH_SUCCESS" ||
                        event.data.type === "GOOGLE_OAUTH_ERROR"
                      ) {
                        clearTimeout(timeout);
                      }
                      listener(event);
                    };
                    return originalListener.call(this, type, wrappedListener);
                  }
                  return originalListener.call(this, type, listener);
                };

                // Wait for response from extension
                return;
              } catch (postMessageError) {
                console.error(
                  "Failed to send OAuth data to extension:",
                  postMessageError
                );
                // Fallback to direct backend call
                await handleDirectBackendCall();
                return;
              }
            } else {
              console.warn(
                "No parent window found, trying direct backend call"
              );
              // Fallback to direct backend call
              await handleDirectBackendCall();
              return;
            }
          } catch (error) {
            console.error("OAuth exchange error:", error);
            console.error("Error details:", error.message);
            statusEl.textContent = "Authentication failed";
            spinnerEl.style.display = "none";
            errorEl.textContent =
              error.message || "Failed to complete authentication";
            errorEl.style.display = "block";
            closeBtn.style.display = "block";

            // Send error message to parent window
            if (window.opener) {
              try {
                window.opener.postMessage(
                  {
                    type: "GOOGLE_OAUTH_ERROR",
                    error: error.message || "Authentication failed",
                  },
                  "*"
                );
              } catch (postMessageError) {
                console.error(
                  "Failed to send error message to parent:",
                  postMessageError
                );
              }
            }
          }
        }

        // Listen for responses from the extension
        window.addEventListener("message", function (event) {
          if (event.data.type === "GOOGLE_OAUTH_SUCCESS") {
            const { userInfo } = event.data;
            statusEl.textContent = "Successfully connected!";
            spinnerEl.style.display = "none";
            successEl.textContent =
              "You can now close this window and return to the extension.";
            successEl.style.display = "block";
            closeBtn.style.display = "block";

            // Auto-close after 2 seconds
            setTimeout(() => {
              window.close();
            }, 2000);
          } else if (event.data.type === "GOOGLE_OAUTH_ERROR") {
            console.error("OAuth error from extension:", event.data.error);
            statusEl.textContent = "Authentication failed";
            spinnerEl.style.display = "none";
            errorEl.textContent = event.data.error || "Authentication failed";
            errorEl.style.display = "block";
            closeBtn.style.display = "block";
          }
        });

        // Start the OAuth flow
        exchangeCodeForToken();
      })();
    </script>
  </body>
</html>
