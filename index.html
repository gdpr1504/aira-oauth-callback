<!DOCTYPE html>
<html>
  <head>
    <title>OAuth Callback</title>
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: #f5f5f5;
      }
      .status-container {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .success {
        color: #4caf50;
      }
      .error {
        color: #f44336;
      }
      .loading {
        color: #2196f3;
      }
    </style>
  </head>
  <body>
    <div class="status-container">
      <h2 id="status">Processing authentication...</h2>
    </div>
    <script>
      (function () {
        console.log("Callback page loaded");

        // Extract access token from URL hash (implicit grant flow)
        const hash = window.location.hash.substring(1);
        const hashParams = new URLSearchParams(hash);
        const accessToken = hashParams.get("access_token");
        const state = hashParams.get("state");
        const error = hashParams.get("error");

        if (error) {
          console.log("OAuth error:", error);
          document.getElementById(
            "status"
          ).textContent = `Authentication failed: ${error}`;
          document.getElementById("status").className = "error";
          return;
        }

        if (accessToken && state && state.startsWith("aira-oauth-")) {
          console.log("Processing OAuth token...");

          // Store access token in localStorage
          localStorage.setItem("aira_oauth_token", accessToken);
          localStorage.setItem("aira_oauth_state", state);
          localStorage.setItem(
            "aira_oauth_token_type",
            hashParams.get("token_type") || "Bearer"
          );
          localStorage.setItem(
            "aira_oauth_expires_in",
            hashParams.get("expires_in") || "3600"
          );
          localStorage.setItem("aira_oauth_timestamp", Date.now().toString());

          console.log("OAuth token stored in localStorage");

          // Send access token to extension via postMessage
          window.postMessage(
            {
              type: "OAUTH_TOKEN",
              token: accessToken,
              state: state,
              tokenType: hashParams.get("token_type"),
              expiresIn: hashParams.get("expires_in"),
            },
            "*"
          );

          // Show success status
          document.getElementById("status").textContent =
            "Authentication successful!";
          document.getElementById("status").className = "success";
        } else {
          console.log("No valid token or state found");
          document.getElementById("status").textContent =
            "No access token found.";
          document.getElementById("status").className = "error";
        }
      })();
    </script>
  </body>
</html>
